<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZEORBIG Metal Analysis Engine</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #f0f0f0;
            overflow-x: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.7s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons (Embedded SVG) ---
        const Icon = ({ path, className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
        );

        const Icons = {
            Music: (props) => <Icon {...props} path='<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>' />,
            Mic2: (props) => <Icon {...props} path='<path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/>' />,
            Info: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>' />,
            FileText: (props) => <Icon {...props} path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/>' />,
            Sparkles: (props) => <Icon {...props} path='<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/>' />,
            Loader2: (props) => <Icon {...props} className={props.className + " animate-spin"} path='<path d="M21 12a9 9 0 1 1-6.219-8.56"/>' />,
            AlertCircle: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>' />,
            Globe: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>' />,
            Youtube: (props) => <Icon {...props} path='<path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17"/><path d="m10 15 5-3-5-3z"/>' />,
            ExternalLink: (props) => <Icon {...props} path='<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>' />,
        };

        // ============================================================
        // AZURE WELL-ARCHITECTED FRAMEWORK - RELIABILITY PATTERNS
        // ============================================================

        // 1. API Key Management
        const getApiKey = () => {
            if (typeof window !== 'undefined' && window.ENV && window.ENV.GEMINI_API_KEY) {
                return window.ENV.GEMINI_API_KEY;
            }
            return "AIzaSyBwJ7Oxw1VYAXi6dsXpP1iA3qwb5Aw8OuQ";
        };

        // 2. CIRCUIT BREAKER PATTERN (Azure WAF RE:07 Self-preservation)
        // States: CLOSED ‚Üí OPEN ‚Üí HALF_OPEN ‚Üí CLOSED
        const CircuitBreaker = {
            state: 'CLOSED', // CLOSED, OPEN, HALF_OPEN
            failureCount: 0,
            successCount: 0,
            lastFailureTime: 0,
            
            // Configuration - AGGRESSIVE PROTECTION
            FAILURE_THRESHOLD: 1,      // 1Î≤à Ïã§Ìå®ÌïòÎ©¥ Ï¶âÏãú OPEN
            SUCCESS_THRESHOLD: 2,      // 2Î≤à ÏÑ±Í≥µÌï¥Ïïº CLOSED
            TIMEOUT_MS: 300000,        // 5Î∂Ñ ÌõÑ HALF_OPENÏúºÎ°ú Ï†ÑÌôò
            
            canRequest() {
                const now = Date.now();
                
                if (this.state === 'CLOSED') {
                    return { allowed: true, reason: null };
                }
                
                if (this.state === 'OPEN') {
                    const elapsed = now - this.lastFailureTime;
                    if (elapsed >= this.TIMEOUT_MS) {
                        console.log('üîÑ Circuit Breaker: OPEN ‚Üí HALF_OPEN (timeout elapsed)');
                        this.state = 'HALF_OPEN';
                        this.successCount = 0;
                        return { allowed: true, reason: 'Testing after timeout' };
                    }
                    const remainingSeconds = Math.ceil((this.TIMEOUT_MS - elapsed) / 1000);
                    return { 
                        allowed: false, 
                        reason: `üõë API Î≥¥Ìò∏ Î™®Îìú: ${remainingSeconds}Ï¥à ÌõÑ ÏûêÎèô Ïû¨ÏãúÎèÑÎê©ÎãàÎã§.`
                    };
                }
                
                if (this.state === 'HALF_OPEN') {
                    return { allowed: true, reason: 'Testing connection' };
                }
                
                return { allowed: true, reason: null };
            },
            
            recordSuccess() {
                if (this.state === 'HALF_OPEN') {
                    this.successCount++;
                    if (this.successCount >= this.SUCCESS_THRESHOLD) {
                        console.log('‚úÖ Circuit Breaker: HALF_OPEN ‚Üí CLOSED');
                        this.state = 'CLOSED';
                        this.failureCount = 0;
                        this.successCount = 0;
                    }
                } else if (this.state === 'CLOSED') {
                    this.failureCount = 0; // Reset on success
                }
            },
            
            recordFailure() {
                this.failureCount++;
                this.lastFailureTime = Date.now();
                
                if (this.state === 'HALF_OPEN') {
                    console.log('‚ùå Circuit Breaker: HALF_OPEN ‚Üí OPEN');
                    this.state = 'OPEN';
                    this.successCount = 0;
                } else if (this.state === 'CLOSED' && this.failureCount >= this.FAILURE_THRESHOLD) {
                    console.log(`üö® Circuit Breaker: CLOSED ‚Üí OPEN (${this.failureCount} failures)`);
                    this.state = 'OPEN';
                }
            },
            
            getStatus() {
                return {
                    state: this.state,
                    failures: this.failureCount,
                    timeUntilRetry: this.state === 'OPEN' 
                        ? Math.max(0, this.TIMEOUT_MS - (Date.now() - this.lastFailureTime))
                        : 0
                };
            },
            
            reset() {
                this.state = 'CLOSED';
                this.failureCount = 0;
                this.successCount = 0;
                this.lastFailureTime = 0;
                console.log('üîß Circuit Breaker: Manual reset');
            }
        };

        // 3. TOKEN BUCKET RATE LIMITER - AGGRESSIVE PROTECTION
        const TokenBucket = {
            tokens: 2,               // Start with only 2 tokens
            maxTokens: 3,            // Max 3 tokens
            refillRate: 1,           // 1 token per 60 seconds
            refillIntervalMs: 60000, // 60Ï¥à Í∞ÑÍ≤©
            lastRefillTime: Date.now(),
            
            refill() {
                const now = Date.now();
                const elapsed = now - this.lastRefillTime;
                const tokensToAdd = Math.floor(elapsed / this.refillIntervalMs) * this.refillRate;
                
                if (tokensToAdd > 0) {
                    this.tokens = Math.min(this.maxTokens, this.tokens + tokensToAdd);
                    this.lastRefillTime = now;
                }
            },
            
            tryConsume(count = 1) {
                this.refill();
                
                if (this.tokens >= count) {
                    this.tokens -= count;
                    console.log(`ü™ô Token consumed. Remaining: ${this.tokens}/${this.maxTokens}`);
                    return true;
                }
                
                console.log(`‚ö†Ô∏è Not enough tokens. Available: ${this.tokens}/${this.maxTokens}`);
                return false;
            },
            
            getWaitTime() {
                if (this.tokens > 0) return 0;
                this.refill();
                if (this.tokens > 0) return 0;
                return this.refillIntervalMs;
            }
        };

        // 4. EXPONENTIAL BACKOFF WITH JITTER (Azure WAF Best Practice)
        const calculateBackoff = (attemptNumber, baseDelayMs = 1000, maxDelayMs = 120000) => {
            // Exponential component
            const exponentialDelay = Math.min(maxDelayMs, baseDelayMs * Math.pow(2, attemptNumber));
            
            // Jitter: Add random variance (0-50% of delay)
            const jitter = exponentialDelay * Math.random() * 0.5;
            
            return Math.round(exponentialDelay + jitter);
        };

        // 5. CACHE MANAGER with TTL
        const CacheManager = {
            CACHE_TTL_MS: 7200000, // 2 hours
            
            _getKey(artist, song) {
                return `metal_cache_${artist.toLowerCase().trim()}_${song.toLowerCase().trim()}`;
            },
            
            get(artist, song) {
                try {
                    const key = this._getKey(artist, song);
                    const cached = localStorage.getItem(key);
                    if (!cached) return null;
                    
                    const data = JSON.parse(cached);
                    const age = Date.now() - data.timestamp;
                    
                    if (age < this.CACHE_TTL_MS) {
                        console.log(`‚úÖ Cache HIT (age: ${Math.round(age/60000)}min)`);
                        return data.value;
                    }
                    
                    console.log('‚ôªÔ∏è Cache expired, removing...');
                    localStorage.removeItem(key);
                } catch (e) {
                    console.error('Cache read error:', e);
                }
                return null;
            },
            
            set(artist, song, value) {
                try {
                    const key = this._getKey(artist, song);
                    localStorage.setItem(key, JSON.stringify({
                        value,
                        timestamp: Date.now()
                    }));
                    console.log('üíæ Result cached');
                } catch (e) {
                    console.error('Cache write error:', e);
                }
            },
            
            clear() {
                const keys = Object.keys(localStorage).filter(k => k.startsWith('metal_cache_'));
                keys.forEach(k => localStorage.removeItem(k));
                console.log(`üßπ Cleared ${keys.length} cached entries`);
            }
        };

        // 6. HELPER FUNCTIONS
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const sanitizeData = (raw) => {
            const asString = (val, defaultText = "") => {
                if (val === null || val === undefined) return defaultText;
                if (typeof val === 'string') return val;
                if (typeof val === 'number') return String(val);
                if (Array.isArray(val)) return val.join('\n');
                if (typeof val === 'object') {
                    try { return JSON.stringify(val); } catch (e) { return defaultText; }
                }
                return defaultText;
            };

            const rawLinks = raw?.externalLinks || {};
            return {
                isMetal: typeof raw?.isMetal === 'boolean' ? raw.isMetal : true,
                lyricsOriginal: asString(raw?.lyricsOriginal, "Lyrics not found."),
                lyricsKorean: asString(raw?.lyricsKorean, "Î≤àÏó≠ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§."),
                artistInfo: asString(raw?.artistInfo, "ÏïÑÌã∞Ïä§Ìä∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§."),
                songInterpretation: asString(raw?.songInterpretation, "Ìï¥ÏÑùÏùÑ ÏÉùÏÑ±ÌïòÎäî Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."),
                walkthrough: asString(raw?.walkthrough, "Ïû†Ïãú ÌõÑ ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî."),
                imagePrompt: asString(raw?.imagePrompt, "Thrash metal aesthetic"),
                externalLinks: {
                    metalArchives: asString(rawLinks?.metalArchives) || null,
                    metalMusicArchives: asString(rawLinks?.metalMusicArchives) || null,
                    wikipedia: asString(rawLinks?.wikipedia) || null,
                    youtube: asString(rawLinks?.youtube) || "https://www.youtube.com/"
                }
            };
        };

        // 7. RESILIENT FETCH with Circuit Breaker + Exponential Backoff + Jitter
        const resilientFetch = async (url, options, maxRetries = 2) => {
            let lastError;
            
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    // Check circuit breaker
                    const circuitStatus = CircuitBreaker.canRequest();
                    if (!circuitStatus.allowed) {
                        throw new Error(circuitStatus.reason);
                    }
                    
                    // Check token bucket
                    if (!TokenBucket.tryConsume()) {
                        const waitTime = TokenBucket.getWaitTime();
                        console.log(`‚è≥ Rate limit: waiting ${waitTime/1000}s for token...`);
                        await wait(waitTime);
                        TokenBucket.tryConsume();
                    }
                    
                    const response = await fetch(url, options);
                    
                    if (response.status === 429) {
                        const retryAfter = response.headers.get('Retry-After');
                        const serverWait = retryAfter ? parseInt(retryAfter) * 1000 : null;
                        
                        CircuitBreaker.recordFailure();
                        
                        if (attempt < maxRetries) {
                            const backoff = serverWait || calculateBackoff(attempt, 30000, 120000);
                            console.warn(`‚ö†Ô∏è 429 Rate limit. Attempt ${attempt + 1}/${maxRetries + 1}. Waiting ${Math.round(backoff/1000)}s...`);
                            await wait(backoff);
                            continue;
                        }
                        
                        throw new Error(`API_RATE_LIMIT`);
                    }
                    
                    if (response.status >= 500) {
                        CircuitBreaker.recordFailure();
                        
                        if (attempt < maxRetries) {
                            const backoff = calculateBackoff(attempt, 5000, 60000);
                            console.warn(`‚ö†Ô∏è Server error ${response.status}. Retrying in ${Math.round(backoff/1000)}s...`);
                            await wait(backoff);
                            continue;
                        }
                        
                        throw new Error(`Server error: ${response.status}`);
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API Error (${response.status}): ${errorText.slice(0, 200)}`);
                    }
                    
                    // Success!
                    CircuitBreaker.recordSuccess();
                    return response;
                    
                } catch (error) {
                    lastError = error;
                    
                    // Don't retry on circuit breaker blocks or known fatal errors
                    if (error.message.includes('Î≥¥Ìò∏ Î™®Îìú') || 
                        error.message === 'API_RATE_LIMIT' ||
                        error.message.includes('API Key')) {
                        break;
                    }
                    
                    // Network error - retry with backoff
                    if (attempt < maxRetries) {
                        const backoff = calculateBackoff(attempt, 3000, 30000);
                        console.warn(`üåê Network error. Retrying in ${Math.round(backoff/1000)}s...`);
                        await wait(backoff);
                    }
                }
            }
            
            throw lastError;
        };

        // 8. MAIN API FUNCTIONS
        const generateContent = async (artist, song, onProgress) => {
            const activeApiKey = getApiKey();
            if (!activeApiKey) {
                throw new Error("API Key is missing.");
            }

            // Check cache first
            const cached = CacheManager.get(artist, song);
            if (cached) {
                onProgress?.('üíæ Ï∫êÏãúÏóêÏÑú Î°úÎìú ÏôÑÎ£å!');
                return cached;
            }

            // Check circuit breaker before any API call
            const circuitStatus = CircuitBreaker.canRequest();
            if (!circuitStatus.allowed) {
                throw new Error(circuitStatus.reason);
            }

            onProgress?.('üéµ AI Î∂ÑÏÑù Ï§ë...');

            const systemPrompt = `
You are the "ZEORBIG Metal Analysis Engine". Your goal is to analyze a song and provide structured data.

Perform the following steps based on the user's Artist Name and Song Title:

1. **Genre Check**: Determine if this artist/song is primarily Metal or a Metal subgenre (e.g., Thrash, Death, Power, Heavy Metal). Set "isMetal" boolean accordingly.
2. **Get Original Lyrics**: Retrieve the full, original English lyrics.
3. **Translate Lyrics**: Translate these lyrics into fluent, emotional Korean.
4. **Artist Info**: Retrieve the artist's discography/bio and translate it into natural Korean (keep proper nouns in English).
5. **Song Interpretation**: Analyze the song's meaning, themes, and context. Explain it in Korean using Markdown.
6. **Walkthrough**: Write a brief Korean intro guiding the user through the content.
7. **Image Prompt**: Create a vivid, dynamic English image prompt for a header image. If Metal, use dark/gritty metal aesthetic. If not Metal, use an aesthetic appropriate for the genre.
8. **External Links**: 
   - **Metal Archives**: ONLY if "isMetal" is true, find the URL on 'metal-archives.com'. Otherwise set to null.
   - **Metal Music Archives**: ONLY if "isMetal" is true, find the URL on 'metalmusicarchives.com'. Otherwise set to null.
   - **Wikipedia**: Provide a relevant Wikipedia URL.
   - **YouTube**: Generate a YouTube search URL for the song.

**CRITICAL OUTPUT INSTRUCTION**:
Output strictly valid JSON. No markdown formatting.
Structure:
{
  "isMetal": boolean,
  "lyricsOriginal": "String",
  "lyricsKorean": "String",
  "artistInfo": "String",
  "songInterpretation": "String",
  "walkthrough": "String",
  "imagePrompt": "String",
  "externalLinks": {
    "metalArchives": "URL String or null",
    "metalMusicArchives": "URL String or null",
    "wikipedia": "URL String or null",
    "youtube": "URL String"
  }
}
            `;

            const response = await resilientFetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${activeApiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Artist: ${artist}, Song: ${song}` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        tools: [{ google_search: {} }]
                    })
                }
            );

            const data = await response.json();
            let textContent = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!textContent) throw new Error("No content generated");

            const jsonStart = textContent.indexOf('{');
            const jsonEnd = textContent.lastIndexOf('}');
            
            if (jsonStart !== -1 && jsonEnd !== -1) {
                textContent = textContent.substring(jsonStart, jsonEnd + 1);
            } else {
                throw new Error("Failed to parse JSON from model response.");
            }
            
            let parsedData;
            try {
                parsedData = JSON.parse(textContent);
            } catch (e) {
                throw new Error("Invalid JSON received from AI model.");
            }

            const sanitized = sanitizeData(parsedData);
            CacheManager.set(artist, song, sanitized);
            
            return sanitized;
        };

        // GRACEFUL DEGRADATION: Image generation DISABLED to prevent 429
        // Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±ÏùÄ ÏôÑÏ†ÑÌûà ÎπÑÌôúÏÑ±ÌôîÌïòÍ≥† Ìï≠ÏÉÅ fallback ÏÇ¨Ïö©
        const generateImage = async (prompt, onProgress) => {
            const FALLBACK_IMAGES = [
                "https://images.unsplash.com/photo-1511735111819-9a3f77e8cc48?q=80&w=2000&auto=format&fit=crop",
                "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=2000&auto=format&fit=crop",
                "https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=2000&auto=format&fit=crop",
                "https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?q=80&w=2000&auto=format&fit=crop",
                "https://images.unsplash.com/photo-1508252592163-5d3c3c559f36?q=80&w=2000&auto=format&fit=crop"
            ];
            
            const getRandomFallback = () => FALLBACK_IMAGES[Math.floor(Math.random() * FALLBACK_IMAGES.length)];
            
            // ALWAYS use fallback - Image API disabled to preserve rate limit
            console.log('üé® Image API disabled. Using high-quality fallback.');
            onProgress?.('üé® Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ï§ë...');
            return getRandomFallback();
            
            /* DISABLED - Image generation causes too many 429 errors
            // If circuit breaker is OPEN, skip image generation entirely (Graceful Degradation)
            const circuitStatus = CircuitBreaker.canRequest();
            if (!circuitStatus.allowed) {
                console.log('üé® Skipping image generation (circuit open). Using fallback.');
                onProgress?.('üé® Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö© Ï§ë...');
                return getRandomFallback();
            }
            
            // If low on tokens, skip image to preserve for text API
            if (TokenBucket.tokens < 2) {
                console.log('üé® Skipping image generation (low tokens). Using fallback.');
                onProgress?.('üé® Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö© Ï§ë...');
                return getRandomFallback();
            }
            */

            const activeApiKey = getApiKey();
            if (!activeApiKey) return getRandomFallback();

            try {
                onProgress?.('üé® Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                
                const response = await resilientFetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:generateImage?key=${activeApiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: prompt + " High quality, photorealistic, cinematic lighting.",
                            numberOfImages: 1,
                            aspectRatio: "16:9"
                        })
                    },
                    1 // Only 1 retry for images
                );

                const data = await response.json();
                const base64Image = data.images?.[0]?.image;
                
                return base64Image ? `data:image/png;base64,${base64Image}` : getRandomFallback();
            } catch (error) {
                console.warn("Image generation failed, using fallback:", error.message);
                return getRandomFallback();
            }
        };

        // --- UI Components ---
        const SectionTitle = ({ children, icon: Icon }) => (
            <h2 className="text-2xl md:text-3xl font-extrabold text-white mb-6 flex items-center gap-3 border-l-4 border-red-600 pl-4 uppercase tracking-widest">
                {Icon && <Icon className="text-red-500 w-6 h-6 md:w-8 md:h-8" />}
                {children}
            </h2>
        );

        const MarkdownText = ({ content }) => {
            if (typeof content !== 'string') {
                return <p className="text-red-400 italic">Content format error.</p>;
            }

            const formatText = (text) => {
                return text.split('\n').map((line, i) => {
                    if (line.startsWith('### ')) return <h3 key={i} className="text-xl font-bold text-red-400 mt-4 mb-2">{line.replace('### ', '')}</h3>;
                    if (line.startsWith('## ')) return <h2 key={i} className="text-2xl font-bold text-white mt-6 mb-3 border-b border-gray-700 pb-2">{line.replace('## ', '')}</h2>;
                    if (line.startsWith('- ')) return <li key={i} className="ml-4 list-disc text-gray-300 mb-1">{line.replace('- ', '')}</li>;
                    if (line.trim() === '') return <br key={i} />;
                    return <p key={i} className="mb-2 text-gray-300 leading-relaxed">{line}</p>;
                });
            };

            return <div className="prose prose-invert max-w-none">{formatText(content)}</div>;
        };

        const ExternalLinkButton = ({ href, label, icon: Icon, colorClass = "bg-gray-800 hover:bg-gray-700" }) => {
            if (!href || typeof href !== 'string') return null;
            
            return (
                <a 
                    href={href} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className={`flex items-center gap-3 px-6 py-4 rounded-xl transition-all transform hover:scale-[1.02] border border-white/10 shadow-lg ${colorClass}`}
                >
                    <Icon className="w-6 h-6 text-white" />
                    <span className="font-bold text-white tracking-wide">{label}</span>
                    <Icons.ExternalLink className="w-4 h-4 text-gray-400 ml-auto" />
                </a>
            );
        };

        // Circuit Breaker Status Component
        const CircuitBreakerStatus = ({ status, onReset }) => {
            const [, forceUpdate] = useState(0);
            
            useEffect(() => {
                if (status.state === 'OPEN') {
                    const interval = setInterval(() => forceUpdate(n => n + 1), 1000);
                    return () => clearInterval(interval);
                }
            }, [status.state]);
            
            if (status.state === 'CLOSED') return null;
            
            const remainingSeconds = Math.ceil(status.timeUntilRetry / 1000);
            
            return (
                <div className="bg-yellow-900/30 border border-yellow-600/50 rounded-xl p-4 mb-6">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <Icons.AlertCircle className="w-6 h-6 text-yellow-500" />
                            <div>
                                <p className="text-yellow-400 font-bold">API Î≥¥Ìò∏ Î™®Îìú ÌôúÏÑ±Ìôî</p>
                                <p className="text-yellow-200/80 text-sm">
                                    {status.state === 'OPEN' 
                                        ? `Rate limit Ï¥àÍ≥ºÎ°ú ${remainingSeconds}Ï¥à ÌõÑ ÏûêÎèô Ïû¨ÏãúÎèÑÎê©ÎãàÎã§.`
                                        : 'Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë...'}
                                </p>
                            </div>
                        </div>
                        <button
                            onClick={onReset}
                            className="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg text-sm font-bold transition-colors"
                        >
                            ÏàòÎèô Ìï¥Ï†ú
                        </button>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [artist, setArtist] = useState('');
            const [song, setSong] = useState('');
            const [loading, setLoading] = useState(false);
            const [step, setStep] = useState('');
            const [result, setResult] = useState(null);
            const [headerImage, setHeaderImage] = useState(null);
            const [error, setError] = useState(null);
            const [circuitStatus, setCircuitStatus] = useState(CircuitBreaker.getStatus());
            
            // Update circuit status periodically
            useEffect(() => {
                const interval = setInterval(() => {
                    setCircuitStatus(CircuitBreaker.getStatus());
                }, 1000);
                return () => clearInterval(interval);
            }, []);
            
            const handleAnalyze = async (e) => {
                e.preventDefault();
                if (!artist || !song) return;

                setLoading(true);
                setError(null);
                setResult(null);
                setHeaderImage(null);

                try {
                    const analysisData = await generateContent(artist, song, setStep);
                    setResult(analysisData);

                    const imageUrl = await generateImage(analysisData.imagePrompt, setStep);
                    setHeaderImage(imageUrl);

                    setStep('‚úÖ ÏôÑÎ£å!');
                } catch (err) {
                    console.error('Analysis error:', err);
                    
                    if (err.message === 'API_RATE_LIMIT') {
                        setError('üö´ API ÏöîÏ≤≠ ÌïúÎèÑ Ï¥àÍ≥º!\n\n2Î∂Ñ ÌõÑ ÏûêÎèôÏúºÎ°ú Ïû¨ÏãúÎèÑÎê©ÎãàÎã§.\nÎòêÎäî Í∞ôÏùÄ Í≥°ÏùÑ Îã§Ïãú Í≤ÄÏÉâÌïòÎ©¥ Ï∫êÏãúÏóêÏÑú Î°úÎìúÎê©ÎãàÎã§.');
                    } else if (err.message.includes('Î≥¥Ìò∏ Î™®Îìú')) {
                        setError(err.message);
                    } else if (err.message.includes('API Key')) {
                        setError('üîë API ÌÇ§ Ïò§Î•ò');
                    } else {
                        setError(err.message || "Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                    }
                } finally {
                    setLoading(false);
                    setTimeout(() => setStep(''), 2000);
                    setCircuitStatus(CircuitBreaker.getStatus());
                }
            };
            
            const handleCircuitReset = () => {
                CircuitBreaker.reset();
                setCircuitStatus(CircuitBreaker.getStatus());
                setError(null);
            };

            return (
                <div className="min-h-screen bg-[#0d0d0d] text-[#f0f0f0] font-sans selection:bg-red-900 selection:text-white">
                    
                    {/* Navigation */}
                    <nav className="border-b border-gray-800 bg-[#111] sticky top-0 z-50 shadow-md">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="bg-black/50 p-2 rounded-lg border border-gray-800">
                                    <img 
                                        src="ZEROBIG_LOGO-20251225-003.png" 
                                        alt="ZEROBIG Logo" 
                                        className="h-10 w-auto object-contain brightness-125 contrast-125 drop-shadow-[0_0_8px_rgba(220,38,38,0.5)]" 
                                        onError={(e) => { e.currentTarget.style.display = 'none'; }}
                                    />
                                </div>
                                <div className="flex flex-col">
                                    <span className="font-black text-2xl tracking-tighter text-white leading-none">
                                        ZEORBIG <span className="text-red-600">METAL</span>
                                    </span>
                                    <span className="text-[0.65rem] text-gray-400 tracking-[0.3em] font-medium uppercase leading-tight">
                                        Analysis Engine v2.0
                                    </span>
                                </div>
                            </div>
                            
                            {/* Token Status */}
                            <div className="hidden md:flex items-center gap-2 text-xs text-gray-500">
                                <span>ü™ô {TokenBucket.tokens}/{TokenBucket.maxTokens}</span>
                                <span className={`w-2 h-2 rounded-full ${
                                    circuitStatus.state === 'CLOSED' ? 'bg-green-500' :
                                    circuitStatus.state === 'HALF_OPEN' ? 'bg-yellow-500' : 'bg-red-500'
                                }`}></span>
                            </div>
                        </div>
                    </nav>

                    {/* Hero / Input Section */}
                    <div className="relative overflow-hidden">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-red-900/20 via-[#0d0d0d] to-[#0d0d0d] z-0 pointer-events-none"></div>

                        <div className="max-w-4xl mx-auto px-4 py-16 relative z-10">
                            <div className="text-center mb-12">
                                <h1 className="text-4xl md:text-6xl font-black mb-4 tracking-tight uppercase">
                                    Analyze the <span className="text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-red-800">Heavy</span>
                                </h1>
                                <p className="text-gray-400 text-lg md:text-xl max-w-2xl mx-auto">
                                    Enter a track to retrieve lyrics, translations, and deep lore analysis powered by AI.
                                </p>
                            </div>

                            {/* Circuit Breaker Status */}
                            <CircuitBreakerStatus status={circuitStatus} onReset={handleCircuitReset} />

                            <form onSubmit={handleAnalyze} className="bg-[#1a1a1a] p-6 md:p-8 rounded-2xl border border-gray-800 shadow-2xl shadow-black/50 backdrop-blur-sm">
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div className="space-y-2">
                                        <label className="text-sm font-semibold text-gray-400 uppercase tracking-wider">Artist Name</label>
                                        <input
                                            type="text"
                                            value={artist}
                                            onChange={(e) => setArtist(e.target.value)}
                                            placeholder="e.g. Metallica"
                                            className="w-full bg-[#0d0d0d] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-red-600 transition-all"
                                            required
                                            disabled={loading}
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-semibold text-gray-400 uppercase tracking-wider">Song Title</label>
                                        <input
                                            type="text"
                                            value={song}
                                            onChange={(e) => setSong(e.target.value)}
                                            placeholder="e.g. Master of Puppets"
                                            className="w-full bg-[#0d0d0d] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-red-600 transition-all"
                                            required
                                            disabled={loading}
                                        />
                                    </div>
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={loading || circuitStatus.state === 'OPEN'}
                                    className="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 shadow-[0_0_20px_rgba(220,38,38,0.3)]"
                                >
                                    {loading ? (
                                        <>
                                            <Icons.Loader2 className="h-5 w-5" />
                                            <span>{step}</span>
                                        </>
                                    ) : circuitStatus.state === 'OPEN' ? (
                                        <>
                                            <Icons.AlertCircle className="h-5 w-5" />
                                            <span>Î≥¥Ìò∏ Î™®Îìú ({Math.ceil(circuitStatus.timeUntilRetry/1000)}Ï¥à ÌõÑ ÌôúÏÑ±Ìôî)</span>
                                        </>
                                    ) : (
                                        <>
                                            <Icons.Sparkles className="h-5 w-5" />
                                            <span>GENERATE ANALYSIS</span>
                                        </>
                                    )}
                                </button>
                            </form>

                            {/* Error Display */}
                            {error && (
                                <div className="mt-8 bg-red-900/30 border border-red-600/50 rounded-xl p-6 text-center animate-fade-in">
                                    <Icons.AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" />
                                    <p className="text-red-300 whitespace-pre-line">{error}</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Results Section */}
                    {result && (
                        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 animate-fade-in">
                            {/* Header Image */}
                            {headerImage && (
                                <div className="relative h-64 md:h-96 rounded-3xl overflow-hidden mb-16 shadow-2xl border border-gray-800">
                                    <img src={headerImage} alt="Generated header" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-[#0d0d0d] via-transparent to-transparent"></div>
                                    <div className="absolute bottom-0 left-0 right-0 p-8">
                                        <h2 className="text-4xl md:text-6xl font-black tracking-tight text-white drop-shadow-lg">{song}</h2>
                                        <p className="text-2xl text-gray-300 font-semibold">{artist}</p>
                                    </div>
                                </div>
                            )}

                            {/* Walkthrough */}
                            {result.walkthrough && (
                                <div className="bg-[#1a1a1a] border border-gray-800 rounded-2xl p-6 mb-12">
                                    <MarkdownText content={result.walkthrough} />
                                </div>
                            )}

                            {/* Main Grid */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
                                {/* Lyrics */}
                                <section className="bg-[#1a1a1a] p-6 md:p-8 rounded-2xl border border-gray-800">
                                    <SectionTitle icon={Icons.Mic2}>Original Lyrics</SectionTitle>
                                    <pre className="whitespace-pre-wrap text-gray-400 font-mono text-sm leading-relaxed max-h-[500px] overflow-y-auto custom-scrollbar">{result.lyricsOriginal}</pre>
                                </section>

                                <section className="bg-[#1a1a1a] p-6 md:p-8 rounded-2xl border border-gray-800">
                                    <SectionTitle icon={Icons.FileText}>ÌïúÍ∏Ä Î≤àÏó≠</SectionTitle>
                                    <pre className="whitespace-pre-wrap text-gray-300 font-sans text-base leading-relaxed max-h-[500px] overflow-y-auto custom-scrollbar">{result.lyricsKorean}</pre>
                                </section>
                            </div>

                            {/* Interpretation */}
                            <section className="bg-[#1a1a1a] p-6 md:p-8 rounded-2xl border border-gray-800 mb-16">
                                <SectionTitle icon={Icons.Sparkles}>Í≥° Ìï¥ÏÑù</SectionTitle>
                                <MarkdownText content={result.songInterpretation} />
                            </section>

                            {/* Artist Info */}
                            <section className="bg-[#1a1a1a] p-6 md:p-8 rounded-2xl border border-gray-800 mb-16">
                                <SectionTitle icon={Icons.Info}>ÏïÑÌã∞Ïä§Ìä∏ Ï†ïÎ≥¥</SectionTitle>
                                <MarkdownText content={result.artistInfo} />
                            </section>

                            {/* External Links */}
                            <section className="mb-16">
                                <SectionTitle icon={Icons.Globe}>External Resources</SectionTitle>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {result.isMetal && (
                                        <>
                                            <ExternalLinkButton href={result.externalLinks.metalArchives} label="Metal Archives" icon={Icons.Music} colorClass="bg-orange-900/50 hover:bg-orange-800/50" />
                                            <ExternalLinkButton href={result.externalLinks.metalMusicArchives} label="Metal Music Archives" icon={Icons.Music} colorClass="bg-orange-800/50 hover:bg-orange-700/50" />
                                        </>
                                    )}
                                    <ExternalLinkButton href={result.externalLinks.wikipedia} label="Wikipedia" icon={Icons.Globe} colorClass="bg-blue-900/50 hover:bg-blue-800/50" />
                                    <ExternalLinkButton href={result.externalLinks.youtube} label="YouTube" icon={Icons.Youtube} colorClass="bg-red-900/50 hover:bg-red-800/50" />
                                </div>
                            </section>
                        </main>
                    )}

                    {/* Footer */}
                    <footer className="border-t border-gray-800 bg-[#111] py-8">
                        <div className="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
                            <p>ZEORBIG Metal Analysis Engine v2.0 &copy; {new Date().getFullYear()}</p>
                            <p className="mt-1">Powered by Gemini AI | Azure Well-Architected Framework</p>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
