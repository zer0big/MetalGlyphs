<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZEORBIG Metal Analysis Engine</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #f0f0f0;
            overflow-x: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.7s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // --- Icons (Embedded SVG) ---
        const Icon = ({ path, className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
        );

        const Icons = {
            Music: (props) => <Icon {...props} path='<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>' />,
            Mic2: (props) => <Icon {...props} path='<path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/>' />,
            Info: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>' />,
            FileText: (props) => <Icon {...props} path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/>' />,
            Sparkles: (props) => <Icon {...props} path='<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/>' />,
            Loader2: (props) => <Icon {...props} className={props.className + " animate-spin"} path='<path d="M21 12a9 9 0 1 1-6.219-8.56"/>' />,
            AlertCircle: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>' />,
            Globe: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>' />,
            Youtube: (props) => <Icon {...props} path='<path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17"/><path d="m10 15 5-3-5-3z"/>' />,
            ExternalLink: (props) => <Icon {...props} path='<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>' />,
        };

        // IMPORTANT: For Azure deployment, replace this with environment variable
        // In Azure Static Web Apps, use Application Settings to set GEMINI_API_KEY
        const getApiKey = () => {
            // Check if environment variable is available (Azure deployment)
            if (typeof window !== 'undefined' && window.ENV && window.ENV.GEMINI_API_KEY) {
                return window.ENV.GEMINI_API_KEY;
            }
            // Fallback to hardcoded key for local development
            return "AIzaSyBwJ7Oxw1VYAXi6dsXpP1iA3qwb5Aw8OuQ";
        };

        // Rate Limiter - 429 ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ ì „ì—­ API í˜¸ì¶œ ì œí•œ
        const RateLimiter = {
            lastCallTime: 0,
            minInterval: 15000, // ìµœì†Œ 15ì´ˆ ê°„ê²©
            
            async waitIfNeeded() {
                const now = Date.now();
                const timeSinceLastCall = now - this.lastCallTime;
                
                if (timeSinceLastCall < this.minInterval) {
                    const waitTime = this.minInterval - timeSinceLastCall;
                    console.log(`â±ï¸ Rate limit protection: waiting ${Math.round(waitTime/1000)}s before API call...`);
                    await wait(waitTime);
                }
                
                this.lastCallTime = Date.now();
            }
        };

        // Cache Manager - ì¤‘ë³µ ìš”ì²­ ë°©ì§€
        const CacheManager = {
            get(key) {
                try {
                    const cached = localStorage.getItem(`metal_cache_${key}`);
                    if (!cached) return null;
                    
                    const data = JSON.parse(cached);
                    const age = Date.now() - data.timestamp;
                    
                    // 1ì‹œê°„ ìºì‹œ
                    if (age < 3600000) {
                        console.log('âœ… Using cached result');
                        return data.value;
                    }
                    
                    localStorage.removeItem(`metal_cache_${key}`);
                } catch (e) {
                    console.error('Cache read error:', e);
                }
                return null;
            },
            
            set(key, value) {
                try {
                    localStorage.setItem(`metal_cache_${key}`, JSON.stringify({
                        value,
                        timestamp: Date.now()
                    }));
                } catch (e) {
                    console.error('Cache write error:', e);
                }
            }
        };

        // --- Helper Functions ---
        const sanitizeData = (raw) => {
            const asString = (val, defaultText = "") => {
                if (val === null || val === undefined) return defaultText;
                if (typeof val === 'string') return val;
                if (typeof val === 'number') return String(val);
                if (Array.isArray(val)) return val.join('\n');
                if (typeof val === 'object') {
                    try {
                        return JSON.stringify(val);
                    } catch (e) {
                        return defaultText;
                    }
                }
                return defaultText;
            };

            const rawLinks = raw?.externalLinks || {};

            return {
                isMetal: typeof raw?.isMetal === 'boolean' ? raw.isMetal : true,
                lyricsOriginal: asString(raw?.lyricsOriginal, "Lyrics not found."),
                lyricsKorean: asString(raw?.lyricsKorean, "ë²ˆì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
                artistInfo: asString(raw?.artistInfo, "ì•„í‹°ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
                songInterpretation: asString(raw?.songInterpretation, "í•´ì„ì„ ìƒì„±í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."),
                walkthrough: asString(raw?.walkthrough, "ì ì‹œ í›„ ë‚´ìš©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”."),
                imagePrompt: asString(raw?.imagePrompt, "Thrash metal aesthetic"),
                externalLinks: {
                    metalArchives: asString(rawLinks?.metalArchives) || null,
                    metalMusicArchives: asString(rawLinks?.metalMusicArchives) || null,
                    wikipedia: asString(rawLinks?.wikipedia) || null,
                    youtube: asString(rawLinks?.youtube) || "https://www.youtube.com/"
                }
            };
        };

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const fetchWithRetry = async (url, options, retries = 3, delay = 5000) => {
            try {
                const response = await fetch(url, options);
                
                if (response.status === 429) {
                    // Rate limit error - MUCH longer wait time
                    const retryAfter = response.headers.get('Retry-After');
                    const waitTime = retryAfter ? parseInt(retryAfter) * 1000 : Math.max(delay, 60000); // ìµœì†Œ 60ì´ˆ
                    
                    if (retries === 0) {
                        throw new Error(`ğŸš« API ìš”ì²­ í•œë„ ì´ˆê³¼: Google APIì˜ ë¬´ë£Œ í‹°ì–´ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ${Math.round(waitTime/1000)}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, ì ì‹œ í›„ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.`);
                    }
                    
                    console.warn(`âš ï¸ 429 Rate limit! Waiting ${Math.round(waitTime/1000)}s...`);
                    await wait(waitTime);
                    return fetchWithRetry(url, options, retries - 1, waitTime * 1.5);
                }
                
                if (!response.ok && response.status >= 500) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                return response;
            } catch (error) {
                if (retries === 0) throw error;
                
                // For network errors or other issues
                if (!error.message.includes('429') && !error.message.includes('í•œë„')) {
                    await wait(delay);
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw error; // Re-throw 429 errors
            }
        };

        const generateContent = async (artist, song) => {
            const activeApiKey = getApiKey();
            
            if (!activeApiKey) {
                throw new Error("API Key is missing. Please check system configuration.");
            }

            // ìºì‹œ í™•ì¸
            const cacheKey = `${artist.toLowerCase()}_${song.toLowerCase()}`;
            const cached = CacheManager.get(cacheKey);
            if (cached) {
                return cached;
            }

            // Rate Limiter ì²´í¬
            await RateLimiter.waitIfNeeded();

            const systemPrompt = `
You are the "ZEORBIG Metal Analysis Engine". Your goal is to analyze a song and provide structured data.

Perform the following steps based on the user's Artist Name and Song Title:

1. **Genre Check**: Determine if this artist/song is primarily Metal or a Metal subgenre (e.g., Thrash, Death, Power, Heavy Metal). Set "isMetal" boolean accordingly.
2. **Get Original Lyrics**: Retrieve the full, original English lyrics.
3. **Translate Lyrics**: Translate these lyrics into fluent, emotional Korean.
4. **Artist Info**: Retrieve the artist's discography/bio and translate it into natural Korean (keep proper nouns in English).
5. **Song Interpretation**: Analyze the song's meaning, themes, and context. Explain it in Korean using Markdown.
6. **Walkthrough**: Write a brief Korean intro guiding the user through the content.
7. **Image Prompt**: Create a vivid, dynamic English image prompt for a header image. If Metal, use dark/gritty metal aesthetic. If not Metal, use an aesthetic appropriate for the genre.
8. **External Links**: 
   - **Metal Archives**: ONLY if "isMetal" is true, find the URL on 'metal-archives.com'. Otherwise set to null.
   - **Metal Music Archives**: ONLY if "isMetal" is true, find the URL on 'metalmusicarchives.com'. Otherwise set to null.
   - **Wikipedia**: Provide a relevant Wikipedia URL.
   - **YouTube**: Generate a YouTube search URL for the song.

**CRITICAL OUTPUT INSTRUCTION**:
Output strictly valid JSON. No markdown formatting.
Structure:
{
  "isMetal": boolean,
  "lyricsOriginal": "String",
  "lyricsKorean": "String",
  "artistInfo": "String",
  "songInterpretation": "String",
  "walkthrough": "String",
  "imagePrompt": "String",
  "externalLinks": {
    "metalArchives": "URL String or null",
    "metalMusicArchives": "URL String or null",
    "wikipedia": "URL String or null",
    "youtube": "URL String"
  }
}
            `;

            const userPrompt = `Artist: ${artist}, Song: ${song}`;

            try {
                const response = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${activeApiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userPrompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            tools: [{ google_search: {} }]
                        })
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    let detailedMsg = "";
                    try {
                        const errorJson = JSON.parse(errorText);
                        detailedMsg = errorJson.error?.message || errorText;
                    } catch (e) {
                        detailedMsg = errorText;
                    }
                    throw new Error(`Gemini API Error (${response.status}): ${detailedMsg}`);
                }
                
                const data = await response.json();
                let textContent = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!textContent) throw new Error("No content generated");

                const jsonStart = textContent.indexOf('{');
                const jsonEnd = textContent.lastIndexOf('}');
                
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    textContent = textContent.substring(jsonStart, jsonEnd + 1);
                } else {
                    throw new Error("Failed to parse JSON structure from model response.");
                }
                
                let parsedData;
                try {
                    parsedData = JSON.parse(textContent);
                } catch (e) {
                    console.error("JSON Parse Error", e);
                    throw new Error("Invalid JSON received from AI model.");
                }

                const sanitized = sanitizeData(parsedData);
                
                // ê²°ê³¼ ìºì‹±
                CacheManager.set(cacheKey, sanitized);
                
                return sanitized;

            } catch (error) {
                console.error("Text Generation Failed", error);
                throw error;
            }
        };

        const generateImage = async (prompt) => {
            const fallbackImage = "https://images.unsplash.com/photo-1511735111819-9a3f77e8cc48?q=80&w=2000&auto=format&fit=crop";
            const activeApiKey = getApiKey();
            
            if (!activeApiKey) return fallbackImage;

            try {
                // ì—°ì† API í˜¸ì¶œ ë°©ì§€ - 3ì´ˆ ëŒ€ê¸°
                console.log('â³ Waiting 3s before image generation...');
                await wait(3000);
                
                // Rate Limiter ì²´í¬
                await RateLimiter.waitIfNeeded();
                
                const response = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:generateImage?key=${activeApiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: prompt + " High quality, photorealistic, cinematic lighting.",
                            numberOfImages: 1,
                            aspectRatio: "16:9"
                        })
                    }
                );

                if (!response.ok) {
                    console.warn("Image generation failed (likely billing/permission), using fallback.");
                    return fallbackImage;
                }

                const data = await response.json();
                const base64Image = data.images?.[0]?.image;
                
                if (!base64Image) return fallbackImage;
                
                return `data:image/png;base64,${base64Image}`;
            } catch (error) {
                console.error("Image Generation Failed", error);
                return fallbackImage;
            }
        };

        // --- Components ---
        const SectionTitle = ({ children, icon: Icon }) => (
            <h2 className="text-2xl md:text-3xl font-extrabold text-white mb-6 flex items-center gap-3 border-l-4 border-red-600 pl-4 uppercase tracking-widest">
                {Icon && <Icon className="text-red-500 w-6 h-6 md:w-8 md:h-8" />}
                {children}
            </h2>
        );

        const MarkdownText = ({ content }) => {
            if (typeof content !== 'string') {
                return <p className="text-red-400 italic">Content format error: Unable to render text.</p>;
            }

            const formatText = (text) => {
                return text.split('\n').map((line, i) => {
                    if (line.startsWith('### ')) return <h3 key={i} className="text-xl font-bold text-red-400 mt-4 mb-2">{line.replace('### ', '')}</h3>;
                    if (line.startsWith('## ')) return <h2 key={i} className="text-2xl font-bold text-white mt-6 mb-3 border-b border-gray-700 pb-2">{line.replace('## ', '')}</h2>;
                    if (line.startsWith('- ')) return <li key={i} className="ml-4 list-disc text-gray-300 mb-1">{line.replace('- ', '')}</li>;
                    if (line.trim() === '') return <br key={i} />;
                    return <p key={i} className="mb-2 text-gray-300 leading-relaxed">{line}</p>;
                });
            };

            return <div className="prose prose-invert max-w-none">{formatText(content)}</div>;
        };

        const ExternalLinkButton = ({ href, label, icon: Icon, colorClass = "bg-gray-800 hover:bg-gray-700" }) => {
            if (!href || typeof href !== 'string') return null;
            
            return (
                <a 
                    href={href} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className={`flex items-center gap-3 px-6 py-4 rounded-xl transition-all transform hover:scale-[1.02] border border-white/10 shadow-lg ${colorClass}`}
                >
                    <Icon className="w-6 h-6 text-white" />
                    <span className="font-bold text-white tracking-wide">{label}</span>
                    <Icons.ExternalLink className="w-4 h-4 text-gray-400 ml-auto" />
                </a>
            );
        };

        // --- Main App ---
        function App() {
            const [artist, setArtist] = useState('');
            const [song, setSong] = useState('');
            const [loading, setLoading] = useState(false);
            const [step, setStep] = useState('');
            const [result, setResult] = useState(null);
            const [headerImage, setHeaderImage] = useState(null);
            const [error, setError] = useState(null);
            
            const handleAnalyze = async (e) => {
                e.preventDefault();
                if (!artist || !song) return;

                setLoading(true);
                setError(null);
                setResult(null);
                setHeaderImage(null);

                try {
                    setStep('ğŸµ Analyzing song data & lyrics...');
                    const analysisData = await generateContent(artist, song);
                    setResult(analysisData);

                    setStep('ğŸ¨ Generating atmospheric header image...');
                    const imageUrl = await generateImage(analysisData.imagePrompt);
                    setHeaderImage(imageUrl);

                } catch (err) {
                    console.error('Analysis error:', err);
                    
                    // User-friendly error messages
                    if (err.message.includes('429') || err.message.includes('í•œë„')) {
                        setError('ğŸš« API ìš”ì²­ í•œë„ ì´ˆê³¼!\n\në¬´ë£Œ APIëŠ” ë¶„ë‹¹ 15íšŒë¡œ ì œí•œë©ë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”\n2. 1-2ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”\n3. ê°™ì€ ê³¡ì€ ìë™ìœ¼ë¡œ ìºì‹œë˜ì–´ ì¬ìš”ì²­í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n\nğŸ’¡ ì—°ì† ê²€ìƒ‰ ì‹œ 15ì´ˆ ê°„ê²©ì„ ë‘ê³  ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    } else if (err.message.includes('API Key')) {
                        setError('ğŸ”‘ API í‚¤ ì˜¤ë¥˜: ì‹œìŠ¤í…œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    } else {
                        setError(err.message || "ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    }
                } finally {
                    setLoading(false);
                    setStep('');
                }
            };

            return (
                <div className="min-h-screen bg-[#0d0d0d] text-[#f0f0f0] font-sans selection:bg-red-900 selection:text-white">
                    
                    {/* Navigation / Brand */}
                    <nav className="border-b border-gray-800 bg-[#111] sticky top-0 z-50 shadow-md">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                {/* Logo Image */}
                                <div className="bg-black/50 p-2 rounded-lg border border-gray-800">
                                    <img 
                                        src="ZEROBIG_LOGO-20251225-003.png" 
                                        alt="ZEROBIG Logo" 
                                        className="h-10 w-auto object-contain brightness-125 contrast-125 drop-shadow-[0_0_8px_rgba(220,38,38,0.5)]" 
                                        onError={(e) => {
                                            e.currentTarget.style.display = 'none'; 
                                        }}
                                    />
                                </div>
                                {/* Text Logo */}
                                <div className="flex flex-col">
                                    <span className="font-black text-2xl tracking-tighter text-white leading-none">
                                        ZEORBIG <span className="text-red-600">METAL</span>
                                    </span>
                                    <span className="text-[0.65rem] text-gray-400 tracking-[0.3em] font-medium uppercase leading-tight">
                                        Analysis Engine
                                    </span>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Hero / Input Section */}
                    <div className="relative overflow-hidden">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-red-900/20 via-[#0d0d0d] to-[#0d0d0d] z-0 pointer-events-none"></div>

                        <div className="max-w-4xl mx-auto px-4 py-16 relative z-10">
                            <div className="text-center mb-12">
                                <h1 className="text-4xl md:text-6xl font-black mb-4 tracking-tight uppercase">
                                    Analyze the <span className="text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-red-800">Heavy</span>
                                </h1>
                                <p className="text-gray-400 text-lg md:text-xl max-w-2xl mx-auto">
                                    Enter a track to retrieve lyrics, translations, and deep lore analysis powered by AI.
                                </p>
                            </div>

                            <form onSubmit={handleAnalyze} className="bg-[#1a1a1a] p-6 md:p-8 rounded-2xl border border-gray-800 shadow-2xl shadow-black/50 backdrop-blur-sm">
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div className="space-y-2">
                                        <label className="text-sm font-semibold text-gray-400 uppercase tracking-wider">Artist Name</label>
                                        <input
                                            type="text"
                                            value={artist}
                                            onChange={(e) => setArtist(e.target.value)}
                                            placeholder="e.g. Metallica"
                                            className="w-full bg-[#0d0d0d] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-red-600 transition-all"
                                            required
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-semibold text-gray-400 uppercase tracking-wider">Song Title</label>
                                        <input
                                            type="text"
                                            value={song}
                                            onChange={(e) => setSong(e.target.value)}
                                            placeholder="e.g. Master of Puppets"
                                            className="w-full bg-[#0d0d0d] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-red-600 transition-all"
                                            required
                                        />
                                    </div>
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 shadow-[0_0_20px_rgba(220,38,38,0.3)]"
                                >
                                    {loading ? (
                                        <>
                                            <Icons.Loader2 className="h-5 w-5" />
                                            <span>{step}</span>
                                        </>
                                    ) : (
                                        <>
                                            <Icons.Sparkles className="h-5 w-5" />
                                            <span>GENERATE ANALYSIS</span>
                                        </>
                                    )}
                                </button>
                                
                                {error && (
                                    <div className="mt-4 p-4 bg-red-900/20 border border-red-800/50 rounded-lg flex items-center gap-3 text-red-200">
                                        <Icons.AlertCircle className="h-5 w-5 flex-shrink-0" />
                                        <p>{error}</p>
                                    </div>
                                )}
                            </form>
                        </div>
                    </div>

                    {/* Results Section */}
                    {result && (
                        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-20 animate-fade-in">
                            
                            {/* Header Image & Walkthrough */}
                            <section className="relative rounded-3xl overflow-hidden border border-gray-800 shadow-2xl">
                                {headerImage ? (
                                    <div className="relative h-[400px] md:h-[500px] w-full">
                                        <img 
                                            src={headerImage} 
                                            alt="Generated Metal Art" 
                                            className="w-full h-full object-cover"
                                        />
                                        <div className="absolute inset-0 bg-gradient-to-t from-[#0d0d0d] via-[#0d0d0d]/40 to-transparent"></div>
                                        <div className="absolute bottom-0 left-0 p-8 md:p-12 max-w-4xl">
                                            <h1 className="text-5xl md:text-7xl font-black text-white mb-2 drop-shadow-lg uppercase">{song}</h1>
                                            <h2 className="text-2xl md:text-3xl font-bold text-red-500 mb-6 drop-shadow-md">{artist}</h2>
                                            <div className="bg-black/60 backdrop-blur-md p-6 rounded-xl border border-white/10">
                                                <p className="text-gray-200 text-lg leading-relaxed font-medium">
                                                    {result.walkthrough}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="h-64 bg-gray-800 flex items-center justify-center">
                                        <Icons.Loader2 className="h-10 w-10 text-gray-500" />
                                    </div>
                                )}
                            </section>

                            {/* Lyrics Comparison */}
                            <section>
                                <SectionTitle icon={Icons.Mic2}>Lyrics Analysis</SectionTitle>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                                    <div className="bg-[#151515] p-6 md:p-8 rounded-2xl border border-gray-800 hover:border-gray-700 transition-colors">
                                        <div className="flex items-center gap-3 mb-6 pb-4 border-b border-gray-800">
                                            <Icons.Globe className="text-gray-400 w-5 h-5" />
                                            <h3 className="text-xl font-bold text-white">Original Lyrics</h3>
                                        </div>
                                        <div className="whitespace-pre-line text-gray-300 leading-8 font-serif text-lg opacity-90">
                                            {result.lyricsOriginal}
                                        </div>
                                    </div>
                                    <div className="bg-[#151515] p-6 md:p-8 rounded-2xl border border-gray-800 hover:border-gray-700 transition-colors">
                                        <div className="flex items-center gap-3 mb-6 pb-4 border-b border-gray-800">
                                            <Icons.FileText className="text-red-500 w-5 h-5" />
                                            <h3 className="text-xl font-bold text-white">Korean Translation</h3>
                                        </div>
                                        <div className="whitespace-pre-line text-gray-100 leading-8 text-lg">
                                            {result.lyricsKorean}
                                        </div>
                                    </div>
                                </div>
                            </section>

                            {/* Song Interpretation */}
                            <section>
                                <SectionTitle icon={Icons.Music}>Deep Dive Interpretation</SectionTitle>
                                <div className="bg-[#151515] p-8 md:p-10 rounded-2xl border border-gray-800 shadow-xl">
                                    <MarkdownText content={result.songInterpretation} />
                                </div>
                            </section>

                            {/* Artist Information & External Links */}
                            <section className="grid grid-cols-1 lg:grid-cols-3 gap-8 pb-20">
                                <div className="lg:col-span-2">
                                    <SectionTitle icon={Icons.Info}>Artist Intelligence</SectionTitle>
                                    <div className="bg-gradient-to-br from-[#151515] to-[#1a1a1a] p-8 md:p-10 rounded-2xl border border-gray-800 h-full">
                                        <MarkdownText content={result.artistInfo} />
                                    </div>
                                </div>
                                
                                <div className="lg:col-span-1">
                                    <SectionTitle icon={Icons.ExternalLink}>External Archives</SectionTitle>
                                    <div className="flex flex-col gap-4">
                                        
                                        {/* Conditionally render Metal Archives links based on isMetal flag */}
                                        {result.isMetal && (
                                            <>
                                                {result.externalLinks?.metalArchives ? (
                                                    <ExternalLinkButton 
                                                        href={result.externalLinks.metalArchives} 
                                                        label="Metal Archives" 
                                                        icon={Icons.Globe} 
                                                        colorClass="bg-[#8b0000] hover:bg-[#a52a2a]"
                                                    />
                                                ) : (
                                                    <div className="px-6 py-4 rounded-xl border border-dashed border-gray-700 text-gray-500 text-center text-sm">
                                                        Metal Archives Not Found
                                                    </div>
                                                )}

                                                {result.externalLinks?.metalMusicArchives && (
                                                    <ExternalLinkButton 
                                                        href={result.externalLinks.metalMusicArchives} 
                                                        label="Metal Music Archives" 
                                                        icon={Icons.Globe}
                                                    />
                                                )}
                                            </>
                                        )}

                                        {/* Always show Wikipedia and YouTube */}
                                        {result.externalLinks?.wikipedia && (
                                            <ExternalLinkButton 
                                                href={result.externalLinks.wikipedia} 
                                                label="Wikipedia Entry" 
                                                icon={Icons.Globe}
                                                colorClass="bg-gray-700 hover:bg-gray-600"
                                            />
                                        )}

                                        <ExternalLinkButton 
                                            href={result.externalLinks?.youtube}
                                            label="Watch on YouTube" 
                                            icon={Icons.Youtube}
                                            colorClass="bg-[#ff0000] hover:bg-[#cc0000]"
                                        />
                                    </div>
                                </div>
                            </section>
                        </main>
                    )}

                    {/* Footer */}
                    <footer className="border-t border-gray-800 py-12 mt-12 bg-[#0a0a0a]">
                        <div className="max-w-7xl mx-auto px-4 text-center">
                            <p className="text-gray-500 mb-4">Powered by ZEORBIG Project</p>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
